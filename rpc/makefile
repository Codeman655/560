# RPC lab makefile
# Doug Slater
# mailto:cds@utk.edu
# CS560 February 2014

IDIR = ./include
SDIR = ./src
BDIR = ./bin
ODIR = $(BDIR)/obj

INCLUDES = -I$(IDIR)
CFLAGS = $(INCLUDES) -g -std=c99
CC = cc

# Output binaries
BIN = bankclient bankserver unit_test

### Files generated by rpcgen
GENH = transaction.h
GENC = transaction_clnt.c transaction_svc.c transaction_xdr.c

# *.h goes to ./include, *.c goes to ./src
GEN = $(GENC:%=$(SDIR)/%) $(GENH:%=$(SDIR)/%) 
###

# Build targets: all with a name from BIN in ./bin/
all: $(BIN)

CLIENTDEPS = bankclient.o transaction_clnt.o clientUtil.o
SERVDEPS = bankserver.o transaction_svc.o serverUtil.o
DEPS = transaction_xdr.o unit_test.o $(CLIENTDEPS) $(SERVDEPS)

define cc-command
$(CC) $(CFLAGS) -o $(BDIR)/$@ $^
endef

# Link objects into binaries
bankclient: transaction_xdr.o $(CLIENTDEPS)
	$(cc-command)

bankserver: transaction_xdr.o $(SERVDEPS)
	$(cc-command)

unit_test: unit_test.o
	$(cc-command)
	
# Each .o file depends on a .c and .h of the same name. 
#$(CLIENTDEPS) $(SERVDEPS) $(ODIR)/%.o: $(SDIR)/%.c $(IDIR)/%.h 

# Build all objects from source
$(DEPS): $(patsubst %.o,$(SDIR)/%.c,$@) $(GENH)
	$(CC) $(CFLAGS) -c -o $@ $(patsubst %.o,$(SDIR)/%.c,$@)	 

# Generate source with rpcgen
$(GENH) $(GENC): transaction.x
	rpcgen transaction.x
	mv $(GENH) $(IDIR)
	mv $(GENC) $(SDIR)
	
clean: 
	rm -f $(GENC:%=$(SDIR)/%)
	rm -f $(IDIR)/$(GENH)
	rm -f $(ODIR)/*
	rm -f ./*.o
	rm -f $(BIN:%=$(BDIR)/%)
